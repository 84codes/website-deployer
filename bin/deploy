#!/usr/bin/env ruby
$stdout.sync = $stderr.sync = true
require 'bundler/setup'
require 'dotenv/load'
require_relative '../website'

name = ARGV.shift
if name.nil?
  puts "Usage: deploy {name}"
  puts "Where name is cloudamqp or cloudmqtt etc."
  exit 1
end
puts "Deploying #{name}"
auth = "#{ENV.fetch 'OAUTH_TOKEN'}:x-oauth-basic"
repo_url = "https://#{auth}@github.com/84codes/#{name}-website.git"
repo_url = "file://#{ENV['REPO_URL']}/#{name}-website" if ENV['RACK_ENV'] == 'development'
domain = "www.#{name}.com"
path = "/tmp/#{name}-#{rand(1000..9999)}"
begin
  FileUtils.mkdir_p path
  Dir.chdir path do
    system "git clone --depth 1 #{repo_url} ."
    Website.new(domain).upload
  end
  puts "#{domain} deployed"
ensure
  FileUtils.rm_rf path
end
